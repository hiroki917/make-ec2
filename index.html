<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PostgreSQL ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .form-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px solid #e9ecef;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 1.1em;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
      }

      .status {
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-weight: 500;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .items-section {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #e9ecef;
      }

      .item-card {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .item-id {
        background: #333;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .item-name {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
      }

      .item-value {
        color: #666;
        margin: 10px 0;
        line-height: 1.5;
      }

      .item-date {
        font-size: 0.9em;
        color: #888;
        margin: 10px 0;
      }

      .btn-delete {
        background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-delete:hover {
        transform: scale(1.05);
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #333;
      }

      .stat-label {
        color: #666;
        margin-top: 5px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ</h1>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <h2>ğŸ“ æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </h2>
        <form id="itemForm">
          <div class="form-group">
            <label for="itemName">åå‰ *</label>
            <input
              type="text"
              id="itemName"
              placeholder="ä¾‹: å•†å“åã€ã‚¿ã‚¹ã‚¯åãªã©"
              required
            />
          </div>

          <div class="form-group">
            <label for="itemValue">è©³ç´°æƒ…å ±</label>
            <textarea
              id="itemValue"
              placeholder="ä¾‹: èª¬æ˜ã€ãƒ¡ãƒ¢ã€è©³ç´°ãªã©ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
            ></textarea>
          </div>

          <button type="submit" class="btn">
            <span id="saveText">ğŸ’¾ ä¿å­˜</span>
            <span id="saveLoading" class="loading hidden"></span>
          </button>
        </form>
      </div>

      <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
      <div style="text-align: center; margin: 30px 0">
        <button onclick="loadItems()" class="btn btn-secondary">
          ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        </button>
        <button onclick="clearAll()" class="btn btn-danger">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
        <button onclick="checkHealth()" class="btn">â¤ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</button>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div id="status"></div>

      <!-- çµ±è¨ˆæƒ…å ± -->
      <div id="statsSection" class="hidden">
        <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3>
        <div class="stats" id="stats"></div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ -->
      <div class="items-section">
        <h3>ğŸ“‹ ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿</h3>
        <div id="items">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <script>
      const API_BASE = "/api";

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", function () {
        loadItems();
        loadStats();

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document
          .getElementById("itemForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveItem();
          });
      });

      function showStatus(message, isError = false) {
        const status = document.getElementById("status");
        status.innerHTML = `<div class="status ${
          isError ? "error" : "success"
        }">${message}</div>`;

        // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
        setTimeout(() => {
          status.innerHTML = "";
        }, 5000);
      }

      function showLoading(show) {
        const saveText = document.getElementById("saveText");
        const saveLoading = document.getElementById("saveLoading");

        if (show) {
          saveText.classList.add("hidden");
          saveLoading.classList.remove("hidden");
        } else {
          saveText.classList.remove("hidden");
          saveLoading.classList.add("hidden");
        }
      }

      async function saveItem() {
        const name = document.getElementById("itemName").value.trim();
        const value = document.getElementById("itemValue").value.trim();

        if (!name) {
          showStatus("âŒ åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true);
          return;
        }

        showLoading(true);

        try {
          const response = await fetch(`${API_BASE}/items`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, value }),
          });

          const result = await response.json();

          if (result.success) {
            showStatus(`âœ… ä¿å­˜æˆåŠŸï¼ ID: ${result.data.id}`);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById("itemName").value = "";
            document.getElementById("itemValue").value = "";

            // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
            loadItems();
            loadStats();
          } else {
            showStatus(`âŒ ä¿å­˜å¤±æ•—: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, true);
        } finally {
          showLoading(false);
        }
      }

      async function loadItems() {
        try {
          const response = await fetch(`${API_BASE}/items`);
          const result = await response.json();

          if (result.success) {
            displayItems(result.data);
            showStatus(`ğŸ“– ${result.data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
          } else {
            showStatus(`âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, true);
          document.getElementById("items").innerHTML =
            "<p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>";
        }
      }

      function displayItems(items) {
        const container = document.getElementById("items");

        if (items.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
          return;
        }

        const html = items
          .map(
            (item) => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-id">ID: ${item.id}</span>
                        <button onclick="deleteItem(${
                          item.id
                        })" class="btn-delete">å‰Šé™¤</button>
                    </div>
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    <div class="item-value">${escapeHtml(
                      item.value || "è©³ç´°æƒ…å ±ãªã—"
                    )}</div>
                    <div class="item-date">ğŸ• ${formatDate(
                      item.created_at
                    )}</div>
                </div>
            `
          )
          .join("");

        container.innerHTML = html;
      }

      async function deleteItem(id) {
        if (!confirm("æœ¬å½“ã«ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          const response = await fetch(`${API_BASE}/items/${id}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showStatus("ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ");
            loadItems();
            loadStats();
          } else {
            showStatus(`âŒ å‰Šé™¤å¤±æ•—: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, true);
        }
      }

      async function clearAll() {
        if (
          !confirm("âš ï¸ å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")
        )
          return;

        try {
          const response = await fetch(`${API_BASE}/items`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showStatus("ğŸ§¹ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
            loadItems();
            loadStats();
          } else {
            showStatus(`âŒ å‰Šé™¤å¤±æ•—: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, true);
        }
      }

      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE}/stats`);
          const result = await response.json();

          if (result.success) {
            displayStats(result.data);
            document.getElementById("statsSection").classList.remove("hidden");
          }
        } catch (error) {
          console.error("Stats loading failed:", error);
        }
      }

      function displayStats(stats) {
        const container = document.getElementById("stats");
        container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalItems}</div>
                    <div class="stat-label">ç·ãƒ‡ãƒ¼ã‚¿æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.uniqueNames}</div>
                    <div class="stat-label">ãƒ¦ãƒ‹ãƒ¼ã‚¯åå‰æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${
                      stats.firstItem ? formatDate(stats.firstItem) : "-"
                    }</div>
                    <div class="stat-label">æœ€åˆã®ãƒ‡ãƒ¼ã‚¿</div>
                </div>
            `;
      }

      async function checkHealth() {
        try {
          const response = await fetch("/health");
          const result = await response.json();

          const healthInfo = `
                    ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ<br>
                    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${result.status}<br>
                    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${result.database}<br>
                    æ¥ç¶šæ™‚é–“: ${result.connectionTime}<br>
                    ç·ã‚¢ã‚¤ãƒ†ãƒ æ•°: ${result.totalItems}<br>
                    PostgreSQLãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${result.postgresVersion}
                `;

          showStatus(healthInfo);
        } catch (error) {
          showStatus(`âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—: ${error.message}`, true);
        }
      }

      // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("ja-JP", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    </script>
  </body>
</html>
