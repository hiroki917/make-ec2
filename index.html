<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PostgreSQL フォームテスト</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .form-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px solid #e9ecef;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 1.1em;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
      }

      .status {
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-weight: 500;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .items-section {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #e9ecef;
      }

      .item-card {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .item-id {
        background: #333;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .item-name {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
      }

      .item-value {
        color: #666;
        margin: 10px 0;
        line-height: 1.5;
      }

      .item-date {
        font-size: 0.9em;
        color: #888;
        margin: 10px 0;
      }

      .btn-delete {
        background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-delete:hover {
        transform: scale(1.05);
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #333;
      }

      .stat-label {
        color: #666;
        margin-top: 5px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🚀 PostgreSQL データベーステスト</h1>

      <!-- フォームセクション -->
      <div class="form-section">
        <h2>📝 新しいデータを追加</h2>
        <form id="itemForm">
          <div class="form-group">
            <label for="itemName">名前 *</label>
            <input
              type="text"
              id="itemName"
              placeholder="例: 商品名、タスク名など"
              required
            />
          </div>

          <div class="form-group">
            <label for="itemValue">詳細情報</label>
            <textarea
              id="itemValue"
              placeholder="例: 説明、メモ、詳細など（オプション）"
            ></textarea>
          </div>

          <button type="submit" class="btn">
            <span id="saveText">💾 保存</span>
            <span id="saveLoading" class="loading hidden"></span>
          </button>
        </form>
      </div>

      <!-- 操作ボタン -->
      <div style="text-align: center; margin: 30px 0">
        <button onclick="loadItems()" class="btn btn-secondary">
          🔄 データ更新
        </button>
        <button onclick="clearAll()" class="btn btn-danger">🗑️ 全削除</button>
        <button onclick="checkHealth()" class="btn">❤️ ヘルスチェック</button>
      </div>

      <!-- ステータス表示 -->
      <div id="status"></div>

      <!-- 統計情報 -->
      <div id="statsSection" class="hidden">
        <h3>📊 統計情報</h3>
        <div class="stats" id="stats"></div>
      </div>

      <!-- データ一覧 -->
      <div class="items-section">
        <h3>📋 保存されたデータ</h3>
        <div id="items">データを読み込み中...</div>
      </div>
    </div>

    <script>
      const API_BASE = "/api";

      // ページ読み込み時の初期化
      document.addEventListener("DOMContentLoaded", function () {
        loadItems();
        loadStats();

        // フォーム送信処理
        document
          .getElementById("itemForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveItem();
          });
      });

      function showStatus(message, isError = false) {
        const status = document.getElementById("status");
        status.innerHTML = `<div class="status ${
          isError ? "error" : "success"
        }">${message}</div>`;

        // 5秒後に自動で消す
        setTimeout(() => {
          status.innerHTML = "";
        }, 5000);
      }

      function showLoading(show) {
        const saveText = document.getElementById("saveText");
        const saveLoading = document.getElementById("saveLoading");

        if (show) {
          saveText.classList.add("hidden");
          saveLoading.classList.remove("hidden");
        } else {
          saveText.classList.remove("hidden");
          saveLoading.classList.add("hidden");
        }
      }

      async function saveItem() {
        const name = document.getElementById("itemName").value.trim();
        const value = document.getElementById("itemValue").value.trim();

        if (!name) {
          showStatus("❌ 名前を入力してください", true);
          return;
        }

        showLoading(true);

        try {
          const response = await fetch(`${API_BASE}/items`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, value }),
          });

          const result = await response.json();

          if (result.success) {
            showStatus(`✅ 保存成功！ ID: ${result.data.id}`);

            // フォームクリア
            document.getElementById("itemName").value = "";
            document.getElementById("itemValue").value = "";

            // データ再読み込み
            loadItems();
            loadStats();
          } else {
            showStatus(`❌ 保存失敗: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`❌ エラーが発生しました: ${error.message}`, true);
        } finally {
          showLoading(false);
        }
      }

      async function loadItems() {
        try {
          const response = await fetch(`${API_BASE}/items`);
          const result = await response.json();

          if (result.success) {
            displayItems(result.data);
            showStatus(`📖 ${result.data.length}件のデータを読み込みました`);
          } else {
            showStatus(`❌ データ取得失敗: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`❌ エラーが発生しました: ${error.message}`, true);
          document.getElementById("items").innerHTML =
            "<p>データの読み込みに失敗しました</p>";
        }
      }

      function displayItems(items) {
        const container = document.getElementById("items");

        if (items.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>📭 データがありません</h3>
                        <p>上のフォームから新しいデータを追加してください</p>
                    </div>
                `;
          return;
        }

        const html = items
          .map(
            (item) => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-id">ID: ${item.id}</span>
                        <button onclick="deleteItem(${
                          item.id
                        })" class="btn-delete">削除</button>
                    </div>
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    <div class="item-value">${escapeHtml(
                      item.value || "詳細情報なし"
                    )}</div>
                    <div class="item-date">🕐 ${formatDate(
                      item.created_at
                    )}</div>
                </div>
            `
          )
          .join("");

        container.innerHTML = html;
      }

      async function deleteItem(id) {
        if (!confirm("本当にこのデータを削除しますか？")) return;

        try {
          const response = await fetch(`${API_BASE}/items/${id}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showStatus("🗑️ 削除しました");
            loadItems();
            loadStats();
          } else {
            showStatus(`❌ 削除失敗: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`❌ エラーが発生しました: ${error.message}`, true);
        }
      }

      async function clearAll() {
        if (
          !confirm("⚠️ 全てのデータを削除しますか？この操作は取り消せません。")
        )
          return;

        try {
          const response = await fetch(`${API_BASE}/items`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showStatus("🧹 全データを削除しました");
            loadItems();
            loadStats();
          } else {
            showStatus(`❌ 削除失敗: ${result.error}`, true);
          }
        } catch (error) {
          showStatus(`❌ エラーが発生しました: ${error.message}`, true);
        }
      }

      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE}/stats`);
          const result = await response.json();

          if (result.success) {
            displayStats(result.data);
            document.getElementById("statsSection").classList.remove("hidden");
          }
        } catch (error) {
          console.error("Stats loading failed:", error);
        }
      }

      function displayStats(stats) {
        const container = document.getElementById("stats");
        container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalItems}</div>
                    <div class="stat-label">総データ数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.uniqueNames}</div>
                    <div class="stat-label">ユニーク名前数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${
                      stats.firstItem ? formatDate(stats.firstItem) : "-"
                    }</div>
                    <div class="stat-label">最初のデータ</div>
                </div>
            `;
      }

      async function checkHealth() {
        try {
          const response = await fetch("/health");
          const result = await response.json();

          const healthInfo = `
                    🏥 ヘルスチェック結果<br>
                    ステータス: ${result.status}<br>
                    データベース: ${result.database}<br>
                    接続時間: ${result.connectionTime}<br>
                    総アイテム数: ${result.totalItems}<br>
                    PostgreSQLバージョン: ${result.postgresVersion}
                `;

          showStatus(healthInfo);
        } catch (error) {
          showStatus(`❌ ヘルスチェック失敗: ${error.message}`, true);
        }
      }

      // ユーティリティ関数
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("ja-JP", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    </script>
  </body>
</html>
